<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Song Analytics</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f5e8df;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }
        .container {
            background-color: #d4b7a3;
            padding: 20px;
            border-radius: 10px;
            width: 600px;
        }
        .header {
            font-weight: bold;
            font-size: 20px;
            margin-bottom: 15px;
        }
        .song-info {
            display: flex;
            align-items: center;
        }
        .song-info img {
            width: 100px;
            height: 100px;
            border-radius: 5px;
            margin-right: 15px;
        }
        .song-title {
            font-size: 24px;
            font-weight: bold;
        }
        .song-artist {
            font-size: 18px;
        }
        .progress-bar {
            background-color: #4c362a;
            height: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .progress {
            background-color: #ddd2e8;
            height: 100%;
            width: 60%;
            border-radius: 5px;
        }
        .play-button {
            text-align: center;
            margin: 10px 0;
        }
        .play-button button {
            background-color: #4c362a;
            color: white;
            padding: 10px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
        }
        .stats {
            background-color: #a67c60;
            padding: 15px;
            border-radius: 10px;
            margin-top: 10px;
        }
        .stats div {
            background-color: #4c362a;
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 5px;
        }
        .controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
        }

        .control-button {
            background-color: #4c362a;
            color: white;
            padding: 15px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            font-size: 18px;
            width: 50px;
            height: 50px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">Song Analytics</div>
        <div class="song-info">
            <img src="{{ song.cover_image.url }}" alt="Song Cover">
            <div>
                <div class="song-title">{{ song.song_name }}</div>
                <div class="song-artist">by {{ song.artist_Name }}</div>
            </div>
        </div>
        <audio id="audio-player" src="{{song.music_File.url}}"></audio>

        <div class="progress-bar">
            <div id="progress" class="progress" style="width: 0%"></div>
        </div>

        <div class="controls">
            <div class="icon-text">
                <button class="control-button" id="play-pause">&#9654;</button>
            </div>        
        </div>

        <div class="stats">
            <div>‚ù§Ô∏è {{ total_likes }} people liked this song</div>
            <div>üìå {{ total_pins }} profile pins!</div>
            <div><strong>Engagement Board</strong><br>
                {% for user in users_liked %}
                    &#10084; {{ user.username }} liked<br>
                {% endfor %}
                {% for user in users_pinned %}
                    &#128204; {{ user.username }} pinned<br>
                {% endfor %}
            </div>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            let audioPlayer = document.getElementById("audio-player");
            let playPauseBtn = document.getElementById("play-pause");
            let progressBar = document.getElementById("progress");
            let downloadBtn = document.getElementById("download-btn");
            let likeBtn = document.getElementById("like-btn");
            let pinBtn = document.getElementById("pin-btn");
            let likeCountSpan = document.getElementById("like-count");
            let pinCountSpan = document.getElementById("pin-count");

            let songID = "{{ song.song_ID }}";  // Fetch song ID dynamically

            // Toggle Play and Pause
            playPauseBtn.addEventListener("click", function () {
                if (audioPlayer.paused) {
                    audioPlayer.play();
                    playPauseBtn.innerHTML = "‚ùö‚ùö";  // Change to pause icon
                } else {
                    audioPlayer.pause();
                    playPauseBtn.innerHTML = "‚ñ∂";  // Change back to play icon
                }
            });

            // Update Progress Bar
            audioPlayer.addEventListener("timeupdate", function () {
                let progress = (audioPlayer.currentTime / audioPlayer.duration) * 100;
                progressBar.style.width = progress + "%";
            });

            // Reset Button to Play Icon When Song Ends
            audioPlayer.addEventListener("ended", function () {
                playPauseBtn.innerHTML = "‚ñ∂";
                progressBar.style.width = "0%";  // Reset progress bar
            });
            if (downloadBtn) {
                downloadBtn.addEventListener("click", function () {
                const link = document.createElement("a");
                link.href = audioPlayer.src; // Get the song file URL
                link.download = "song.mp3"; // Default file name
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });
           }
           
           // ‚úÖ Function to get CSRF token from cookies
           function getCSRFToken() {
    let csrfToken = null;
    document.cookie.split(";").forEach(cookie => {
        let [name, value] = cookie.trim().split("=");
        if (name === "csrftoken") {
            csrfToken = value;
        }
    });
    return csrfToken;
}


function getCSRFToken() {
        return document.cookie.split("; ")
            .find(row => row.startsWith("csrftoken="))
            ?.split("=")[1];
    }

    function updateSongInteraction(type, button, countSpan, activeClass, defaultText) {
    fetch(`/song/${songID}/update/`, {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCSRFToken()
        },
        body: JSON.stringify({ action: type })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === "success") {
            if (type === "like") {
                button.classList.toggle(activeClass); // Toggle class
                countSpan.textContent = `${data.likes} likes`; // Update like count
            } else if (type === "pin") {
                button.classList.toggle(activeClass); // Toggle class
                countSpan.textContent = button.classList.contains(activeClass) ? "Pinned" : defaultText;
            }
        }
    })
    .catch(error => console.error("Error:", error));
}



// ‚úÖ Add event listeners for Like and Pin
if (likeBtn) {
    likeBtn.addEventListener("click", function () {
        updateSongInteraction("like", likeBtn, likeCountSpan, "liked", "like");
    });
}

if (pinBtn) {
    pinBtn.addEventListener("click", function () {
        updateSongInteraction("pin", pinBtn, pinCountSpan, "pinned", "pin");
    });
    
}

        });
    </script>
</body>
</html>
