<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Song</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #d4b7a3;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }
        .container {
            display: flex;
            background-color: #c09c7a;
            padding: 20px;
            border-radius: 10px;
            width: 700px;
        }
        .left-panel {
            width: 40%;
            padding: 15px;
        }
        .right-panel {
            width: 60%;
            padding: 15px;
            background-color: #d4b7a3;
            border-radius: 10px;
            margin: 15px;
        }
        .left-panel img {
            width: 100%;
            border-radius: 5px;
        }
        .button {
            background-color: #4c362a;
            color: white;
            border: none;
            padding: 10px;
            width: 100%;
            border-radius: 5px;
            margin-top: 10px;
            cursor: pointer;
        }
        .delete-button {
            background-color: #ff5c5c;
        }
        .song-title {
            width: 91%;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ccc;
            margin-top: 10px;
        }
        .song-info {
            display: flex;
            align-items: center;
        }
        .song-info img {
            width: 60px;
            height: 60px;
            border-radius: 5px;
            margin-right: 10px;
        }
        .progress-bar {
            background-color: #4c362a;
            height: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .progress {
            background-color: #ddd2e8;
            height: 100%;
            width: 40%;
            border-radius: 5px;
        }
        .play-button {
            display: flex;
            justify-content: center;
            margin-top: 10px;
        }
        .play-button button {
            background-color: #4c362a;
            color: white;
            padding: 15px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
        }
        .controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
        }

        .control-button {
            background-color: #4c362a;
            color: white;
            padding: 15px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            font-size: 18px;
            width: 50px;
            height: 50px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="left-panel">
            <h2><strong>Edit Song</strong></h2>
            <img src="{{ song.cover_image.url}}" alt="Song Cover">
            <form method="post" enctype="multipart/form-data">
                {% csrf_token %}
                <input type="file" name="cover_image" accept="image/*" hidden id = "id_cover_image">
                <button type= "button" class="button" onclick= "document.getElementById('id_cover_image').click()">Upload New Photo</button>
                <input type="text" class="song-title" name="song_name" value="{{ song.song_name }}">
                <button type="submit" class="button">Save Changes</button>
            </form>
        </div>
        <div class="right-panel">
            <div class="song-info">
                <img src="{{ song.cover_image.url}}" alt="Song Cover">
                <div>
                    <h3>{{ song.song_name }}</h3>
                    <p>by {{ song.artist_Name }}</p>
                </div>
            </div>
            <audio id="audio-player" src="{{song.music_File.url}}"></audio>

            <div class="progress-bar">
                <div id="progress" class="progress" style="width: 0%"></div>
            </div>
    
            <div class="controls">
                <div class="icon-text">
                    <button class="control-button" id="play-pause">&#9654;</button>
                </div>        
            </div>
    </div>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            let audioPlayer = document.getElementById("audio-player");
            let playPauseBtn = document.getElementById("play-pause");
            let progressBar = document.getElementById("progress");
            let downloadBtn = document.getElementById("download-btn");
            let likeBtn = document.getElementById("like-btn");
            let pinBtn = document.getElementById("pin-btn");
            let likeCountSpan = document.getElementById("like-count");
            let pinCountSpan = document.getElementById("pin-count");

            let songID = "{{ song.song_ID }}";  // Fetch song ID dynamically

            // Toggle Play and Pause
            playPauseBtn.addEventListener("click", function () {
                if (audioPlayer.paused) {
                    audioPlayer.play();
                    playPauseBtn.innerHTML = "❚❚";  // Change to pause icon
                } else {
                    audioPlayer.pause();
                    playPauseBtn.innerHTML = "▶";  // Change back to play icon
                }
            });

            // Update Progress Bar
            audioPlayer.addEventListener("timeupdate", function () {
                let progress = (audioPlayer.currentTime / audioPlayer.duration) * 100;
                progressBar.style.width = progress + "%";
            });

            // Reset Button to Play Icon When Song Ends
            audioPlayer.addEventListener("ended", function () {
                playPauseBtn.innerHTML = "▶";
                progressBar.style.width = "0%";  // Reset progress bar
            });
            if (downloadBtn) {
                downloadBtn.addEventListener("click", function () {
                const link = document.createElement("a");
                link.href = audioPlayer.src; // Get the song file URL
                link.download = "song.mp3"; // Default file name
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });
           }
           
           // ✅ Function to get CSRF token from cookies
           function getCSRFToken() {
    let csrfToken = null;
    document.cookie.split(";").forEach(cookie => {
        let [name, value] = cookie.trim().split("=");
        if (name === "csrftoken") {
            csrfToken = value;
        }
    });
    return csrfToken;
}


function getCSRFToken() {
        return document.cookie.split("; ")
            .find(row => row.startsWith("csrftoken="))
            ?.split("=")[1];
    }

    function updateSongInteraction(type, button, countSpan, activeClass, defaultText) {
    fetch(`/song/${songID}/update/`, {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCSRFToken()
        },
        body: JSON.stringify({ action: type })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === "success") {
            if (type === "like") {
                button.classList.toggle(activeClass); // Toggle class
                countSpan.textContent = `${data.likes} likes`; // Update like count
            } else if (type === "pin") {
                button.classList.toggle(activeClass); // Toggle class
                countSpan.textContent = button.classList.contains(activeClass) ? "Pinned" : defaultText;
            }
        }
    })
    .catch(error => console.error("Error:", error));
}



// ✅ Add event listeners for Like and Pin
if (likeBtn) {
    likeBtn.addEventListener("click", function () {
        updateSongInteraction("like", likeBtn, likeCountSpan, "liked", "like");
    });
}

if (pinBtn) {
    pinBtn.addEventListener("click", function () {
        updateSongInteraction("pin", pinBtn, pinCountSpan, "pinned", "pin");
    });
    
}

        });
    </script>
</body>
</html>
